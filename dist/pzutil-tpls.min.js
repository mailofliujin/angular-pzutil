/*
 * pzutil
 * 

 * Version: 0.0.18 - 2014-08-07
 * License: MIT
 */
angular.module("pzutil",["pzutil.tpls","pzutil.aditem","pzutil.adpublish","pzutil.image","pzutil.modal","pzutil.rest","pzutil.retailhelper","pzutil.services","pzutil.simplegrid","pzutil.tree","pzutil.ztemplate"]),angular.module("pzutil.tpls",["template/aditem/aditem.tpl.html","template/adpublish/adpublish_grid.tpl.html","template/adpublish/adpublish_list.tpl.html","template/adpublish/adpublish_slide.tpl.html","template/modal/modal.html","template/modal/wait.html","template/simplegrid/footer.html","template/simplegrid/header.html","template/simplegrid/simpleGrid-normal.html","template/simplegrid/simpleGrid-simple.html","template/simplegrid/simpleGrid.html"]),angular.module("pzutil.aditem",[]).directive("adItem",["rest",function(){return{restrict:"E",scope:{item:"=",itemClass:"=",itemStyle:"="},templateUrl:"template/aditem/aditem.tpl.html",link:function(a){a.getItemTemplate=function(){switch(a.item.type){case 0:return"html.tpl.html";case 1:return"taxonImage.tpl.html";case 2:return"productImagePrice.tpl.html";case 3:return"promotion.tpl.html";case 4:return"imageClickable.tpl.html";case 5:return"imageNotClickable.tpl.html"}},a.itemStyle=angular.fromJson(a.itemStyle)||{},console.log(a.itemClass)}}}]),angular.module("pzutil.adpublish",[]).directive("adPublish",["rest","retailHelper",function(a,b){return{restrict:"E",scope:{place:"=",itemClass:"@",itemStyle:"@"},templateUrl:function(a,b){return b.template?"template/adpublish/"+b.template+".tpl.html":3==b.place?"template/adpublish/adpublish_slide.tpl.html":"template/adpublish/adpublish_grid.tpl.html"},link:function(c){c.loading=!0,a.callApi("adpublish",{place:c.place}).then(function(d){switch(c.items=d.data[0],c.place){case 0:c.placeText="adpublish.place.feature";break;case 1:c.placeText="adpublish.place.new";break;case 2:c.placeText="adpublish.place.staffPick";break;case 50:c.placeText="adpublish.place.adminHighlights"}_(c.items).forEach(function(c){c.props=angular.fromJson(c.props)||{},2==c.type&&a.callApi("getProduct",{pid:c.props.product}).then(function(a){c.product=a.data[0][0];var d=_.max(a.data[1],"retail"),e=_.min(a.data[1],"retail");c.product.retail=b.getRetail(e.retail,d.retail);var f=[];_(a.data[1]).forEach(function(a){a.images&&_(a.images.split(",")).forEach(function(a){f.push(a)})}),c.product.images=f,f.length>0&&(c.product.image=f[0])})}),c.loading=!1})}}}]),angular.module("pzutil.image",[]).factory("imageHelper",[function(){var a={getUrl:function(a,b){return"http://portalvhdsmzdfsgd15ll8f.blob.core.windows.net/"+(b?b+"/":"")+a}};return a}]).filter("zImageUrl",["imageHelper",function(a){return function(b,c){return a.getUrl(b,c)}}]),angular.module("pzutil.modal",[]).directive("crudModal",function(){return{restrict:"E",replace:!0,transclude:"element",templateUrl:"template/modal/modal.html"}}).factory("crudWait",["$http","$modal",function(a,b){var c={doWork:function(a,c,d){var e=b.open({templateUrl:"template/modal/wait.html",controller:"crudWaitCtrl",resolve:{msg:function(){return a}}});e.result.then(function(){},function(){}),c.then(function(){d(),e.close()})}};return c}]).controller("crudWaitCtrl",["$scope","$modalInstance","msg",function(a,b,c){a.msg=c}]),angular.module("pzutil.rest",[]).factory("rest",["$http",function(a){var b="/api/public",c={callApi:function(c,d){return d=d||{},d.aid=401,a.post(b+"/"+c,d)}};return c}]),angular.module("pzutil.retailhelper",[]).factory("retailHelper",[function(){var a={getRetail:function(a,b){return a==b?accounting.formatMoney(b):accounting.formatMoney(a)+" ~ "+accounting.formatMoney(b)}};return a}]),angular.module("pzutil.services",[]).factory("attrHelper",[function(){var a={parseIds:function(a,b){var c=[];return _(a.split(",")).forEach(function(a){var d=_.find(b,{id:a});d&&c.push(d.name)}),c.join(", ")}};return a}]).factory("localizedMessages",["$interpolate","I18N.MESSAGES",function(a,b){var c=function(a,b){return a||b};return{get:function(d,e){var f=b[d];return f?a(f)(e):c(f,d)},rawGet:function(a){return b[a]}}}]).filter("i18n",["localizedMessages",function(a){return function(b){return a.get(b)}}]).directive("i18n",["localizedMessages",function(a){var b={restrict:"EAC",updateText:function(b,c){b.text(a.get(c,interpolateParams))},link:function(a,c,d){d.$observe("i18n",function(){b.updateText(c,d.i18n)})}};return b}]).directive("i18nAttr",["localize",function(a){var b={restrict:"EAC",updateText:function(b,c){b.text(a.get(c,interpolateParams))},link:function(a,c,d){d.$observe("i18nAttr",function(a){b.updateText(c,a)})}};return b}]),angular.module("pzutil.simplegrid",["pzutil.services","pzutil.modal"]).factory("sgColumn",["localizedMessages",function(a){var b=function(b){var c=b.sorter,d=b.myLookup,e=b.myLookupTitle,f=function(a){console.info(a.name,b.sgCheckColumn),a.checkbox=b.sgCheckColumn==a.name,angular.extend(this,a)};return f.sorter=c,f.New=function(a){return new f(a)},f.Parse=function(a){if(a){for(var b=angular.fromJson(a),c=[],d=0;d<b.length;d++)c.push(new f(b[d]));return c}},f.prototype.$getTitle=function(){if(this.res)return a.get(this.res);var b=this.name;return e&&(b=e({col:b})),b||this.name},f.prototype.$getColumnClass=function(){var a=this.width?this.width:2,b=this.checkbox?"checkbox checkbox-cell ":"";return this.align?b+"sg-gridrow-cell col-md-"+a+" text-"+this.align:b+"sg-gridrow-cell col-md-"+a},f.prototype.$sort=function(){this.sortOrder=!this.sortOrder,f.sorter(this)},f.prototype.$getText=function(a){var b=a[this.name];return this.bool?"":(d&&(b=d({col:this.name,value:b,item:a})),b)},f};return b}]).directive("simpleGrid",["sgColumn","breadcrumbs","localizedMessages","crudWait",function(a,b,c,d){return{restrict:"E",replace:!0,scope:{data:"=sgData",sgAddObject:"&",sgSortOptions:"=",itemtemplate:"=sgTemplate",sgColumns:"@",sgDelObject:"&",sgAllowDel:"@",sgNoPager:"=",sgOnClick:"&",sgLookup:"&",sgGlobalSearch:"@",sgPageSize:"@",sgOptions:"=",sgOnChange:"&",sgLookupTitle:"&",sgCheckColumn:"@",sgCustomSearch:"&"},templateUrl:function(a,b){var c=b.sgTemplate;if(c){var d=".grid.tpl.html'";return-1!==c.indexOf(d,c.length-d.length)?"template/simplegrid/simpleGrid-simple.html":"template/simplegrid/simpleGrid.html"}return"template/simplegrid/simpleGrid-normal.html"},link:function(e,f,g){var h=function(a,b,c){var c=c||a;_(e.columns).forEach(function(b){b.name!=a&&(b.sortOrder=void 0)}),e.data.sort(function(a,d){var e,f=a[c],g=d[c];return e=null==f?-1:null==g?1:angular.isString(f)?f.localeCompare(g):g>f?-1:1,e*(b?1:-1)})};e.sorter=function(a){h(a.name,a.sortOrder,a.sortField)},e.AddObject=function(){e.data.push(a.New(e.sgAddObject()))},e.DelObject=function(a){if(confirm(c.get("common.del"))){var b=e.data.indexOf(a);e.data.splice(b,1),e.sgDelObject&&e.sgDelObject(a)}},e.myLookup=g.sgLookup?e.sgLookup:null,e.myLookupTitle=g.sgLookupTitle?e.sgLookupTitle:null,e.columns=a(e).Parse(g.sgColumns),e.sortGrid=function(a){if(e.sgSortOptions){var b=_.find(e.sgSortOptions,{selected:!0});b&&h(b.name,a)}},e.sortGrid(!0),e.scrollStyle=g.gridHeight?"height:"+g.gridHeight+";overflow-y:auto":"";var i=e.pageSetting={};i.pageSize=e.sgNoPager?100:e.sgPageSize?parseInt(e.sgPageSize):20,i.currentPage=1,i.totalItems=e.data.length,e.clickRow=function(a,b){b.ctrlKey?a.$__selected=!a.$__selected:e.sgOnClick({id:a.id})},e.checkAll=function(a){e.checkedAll=!e.checkedAll,_(e.items).forEach(function(b){b.$__selected=a})},e.resetChecks=function(){var a=_.find(e.columns,{name:e.sgCheckColumn});a&&(a.checkedAll=!1),_(e.items).forEach(function(a){a.hasOwnProperty("$__selected")&&delete a.$__selected})},e.getIndex=function(a){return e.items.indexOf(a)+1},e.changed=function(a,f){var h=i.pageSize;i.currentPage=a,f&&e.resetChecks(),console.log(a);var j=null;if(e.sgGlobalSearch&&b.listingSearch&&""!=b.listingSearch){var k=b.listingSearch.toLowerCase();j=_.filter(e.data,function(a){for(var b=0;b<e.columns.length;b++){var c=e.columns[b].name,d=a[c];if(e.myLookup&&(d=e.myLookup({col:c,value:d,item:a})),d&&d.toString().toLowerCase().indexOf(k)>-1)return!0}return e.sgCustomSearch?e.sgCustomSearch({item:a,search:k}):!1}),i.totalItems=j.length;var l=Math.ceil(i.totalItems/h);a>l&&(a=1,i.currentPage=a)}else j=e.data;var m=_.take(_.rest(j,(a-1)*h),h),n=function(){e.items?(e.items.length=0,e.items.push.apply(e.items,m)):e.items=m,i.totalItems=j.length,e.footer=c.get(i.totalItems<=i.pageSize?"common.totalcount1Page":"common.totalcount",{from:h*(a-1)+1,to:Math.min(h*a,i.totalItems),total:i.totalItems})};g.sgOnChange?d.doWork("Please wait...",e.sgOnChange({items:m}),n):n()},e.sgGlobalSearch&&e.$watch(function(){return b.listingSearch},function(){e.changed(i.currentPage)}),e.$watchCollection(function(){return e.data},function(){e.changed(i.currentPage)})}}}]),angular.module("pzutil.tree",[]).factory("zTreeHelper",[function(){var a=function(b,c,d,e,f,g){var h=_.filter(b,function(a){var b=a.parentid?a.parentid:0;return e?null==c?a[e]==d&&0==b:b==c.id&&a[e]==d:null==c?0==b:b==c.id});if(h=_.sortBy(_.sortBy(h,"name"),"position"),null!=c&&(c.children=h),f||g){var g=1;_(h).forEach(function(c){g&&(c.position=g),f&&a(b,c,d,e,f,g),g++})}return h},b=function(a,c,d,e){_(e).forEach(function(e){var f=d+e.name;e[c]&&a.push({id:e.id,name:f}),b(a,c,e.id?f+" >> ":"",e.children)})},c=function(a,b,c,d,e){var f,g=d[c],h=0;return g?(h=d.parentid?d.parentid:0,f=(0==h?_.find(a,{id:g}):_.find(b,{id:h})).children):f=a,e?_.findLast(f,function(a){var b=a.parentid?a.parentid:0;return console.log(a.position.toString()+":"+d.position.toString()),h==b&&a.position<d.position}):_.find(f,function(a){var b=a.parentid?a.parentid:0;return h==b&&a.position>d.position})},d=function(){return uuid.v4()},e={buildTree:function(b,c,d,e,f){if(d){var g=1;f&&b.sort(function(a,b){return a.position-b.position}),_(b).forEach(function(b){f&&(b.position=g),b.children=a(c,null,b.id,d,e,f),g++})}else a(c,null,null,d,e,f)},addTreeItem:function(a,b,c,e,f,g,h){if(a){if(a.root&&f){var i=f();i.children=[],i.id=d(b),b.push(i)}else{var i=g();i.children=[],i.id=d(c),e?a[e]?(i[e]=a[e],i.parentid=a.id):i[e]=a.id:a.root||(i.parentid=a.id),c.push(i)}h()}},moveTreeItem:function(a,b,d,e,f,g){var h=c(a,b,d,e,f);if(h){var i=e.position;e.position=h.position,h.position=i,g()}},buildDropdownList:function(a,c){var d=[];return b(d,a,"",c),d}};return e}]),angular.module("pzutil.ztemplate",["pzutil.services"]).directive("zTemplate",["localizedMessages","$compile",function(a,b){return{restrict:"A",scope:!1,compile:function(){return function(a,c,d){var e=c.scope(),f=e.$eval(d.zTemplate);c.append(b(f)(e))}}}}]),angular.module("template/aditem/aditem.tpl.html",[]).run(["$templateCache",function(a){a.put("template/aditem/aditem.tpl.html",'<script type="text/ng-template"  id="html.tpl.html">\n    <div ng-style="itemStyle" ng-class="itemClass"  >\n        <span z-template="item.props.html" ></span>\n    </div>\n</script>\n<script type="text/ng-template"  id="taxonImage.tpl.html">\n    <a href="#" target="_blank">\n        <img ng-src="{{item.props.images | zImageUrl:\'s2kcontainer\'}}" ng-style="itemStyle" ng-class="itemClass"  />\n        <div class="carousel-caption">\n            <p>{{item.props.title}}</p>\n        </div>\n    </a>\n\n</script>\n<script type="text/ng-template"  id="productImagePrice.tpl.html">\n    <a href="product/{{item.product.productid}}" target="_blank">\n        <img ng-src="{{item.product.image | zImageUrl:\'s2kcontainer\'}}"  ng-style="itemStyle" ng-class="itemClass"  />\n        <div class="carousel-caption">\n            <p>{{item.product.retail}}</p>\n        </div>\n    </a>\n</script>\n<script type="text/ng-template"  id="promotion.tpl.html">\n    <a href="#" target="_blank">\n        <img ng-src="{{item.props.images | zImageUrl:\'s2kcontainer\'}}"  ng-style="itemStyle"  ng-class="itemClass" />\n        <div class="carousel-caption">\n            <p>{{item.props.title}}</p>\n        </div>\n    </a>\n\n</script>\n<script type="text/ng-template"  id="imageClickable.tpl.html">\n    <a href="{{item.props.targetUrl}}" target="_blank">\n        <img ng-src="{{item.props.images | zImageUrl:\'s2kcontainer\'}}" ng-style="itemStyle"  ng-class="itemClass"/></a>\n</script>\n<script type="text/ng-template"  id="imageNotClickable.tpl.html">\n    <img ng-src="{{item.props.images | zImageUrl:\'s2kcontainer\'}}" ng-style="itemStyle"  ng-class="itemClass" />\n</script>\n<div ng-include="getItemTemplate()">\n</div>\n\n')}]),angular.module("template/adpublish/adpublish_grid.tpl.html",[]).run(["$templateCache",function(a){a.put("template/adpublish/adpublish_grid.tpl.html",'<div>\n    <div  ng-if="!loading && items && items.length">\n        <div class="page-header" >\n            <h3>{{ placeText | i18n }}</h3>\n        </div>\n        <div ng-repeat="item in items" class="col-md-4" style="padding-top:10px;padding-bottom: 10px">\n            <ad-item item="item" item-class="itemClass" item-style="itemStyle"></ad-item>\n        </div>\n    </div>\n    <i class="fa fa-spinner fa-spin fa-2x" ng-if="loading" style="position: absolute;left: 50%;top: 50%;"/>\n</div>\n\n')}]),angular.module("template/adpublish/adpublish_list.tpl.html",[]).run(["$templateCache",function(a){a.put("template/adpublish/adpublish_list.tpl.html",'<div>\n    <div  ng-if="!loading && items && items.length">\n        <div ng-repeat="item in items" class="col-md-12" style="padding-top:10px;padding-bottom: 10px">\n            <ad-item item="item" item-class="itemClass" item-style="itemStyle"></ad-item>\n        </div>\n    </div>\n    <i class="fa fa-spinner fa-spin fa-2x" ng-if="loading" style="position: absolute;left: 50%;top: 50%;"/>\n\n</div>\n\n')}]),angular.module("template/adpublish/adpublish_slide.tpl.html",[]).run(["$templateCache",function(a){a.put("template/adpublish/adpublish_slide.tpl.html",'<div>\n    <div  ng-if="!loading">\n        <carousel interval="5000">\n            <slide ng-repeat="item in items" active="item.active">\n                <ad-item item="item" item-class="itemClass" item-style="itemStyle"></ad-item>\n            </slide>\n        </carousel>\n    </div>\n    <i class="fa fa-spinner fa-spin fa-2x" ng-if="loading" style="position: absolute;left: 50%;top: 50%;"/>\n</div>')}]),angular.module("template/modal/modal.html",[]).run(["$templateCache",function(a){a.put("template/modal/modal.html",'<div>\n    <div class="modal-header">\n        <h3>Edit {{heading()}}</h3>\n    </div>\n    <div class="modal-body">\n        <div ng-transclude></div>\n    </div>\n    <div class="modal-footer">\n        <div class="btn-toolbar page-header-ztree" role="toolbar">\n            <button type="button" class="btn btn-default"  ng-click="ok()"><i class="fa fa-save"></i> OK</button>\n            <button type="button" class="btn btn-default" ng-click="cancel()"><i class="fa fa-undo"></i> Cancel</button>\n        </div>\n    </div>\n</div>')}]),angular.module("template/modal/wait.html",[]).run(["$templateCache",function(a){a.put("template/modal/wait.html",'<div class="modal-body">\n    <div class="progress progress-striped active">\n        <div class="progress-bar"  role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%">\n            {{msg}}\n        </div>\n    </div>\n</div>')}]),angular.module("template/simplegrid/footer.html",[]).run(["$templateCache",function(a){a.put("template/simplegrid/footer.html",'<div class="row">\n    <div class="col-md-9">\n        <pagination ng-if="!sgNoPager && pageSetting.totalItems>pageSetting.pageSize"\n                    total-items="pageSetting.totalItems" page="pageSetting.currentPage" items-per-page="pageSetting.pageSize" rotate="false"\n                    max-size="5" class="pagination-sm" boundary-links="true"  on-select-page="changed(page, true)" />\n    </div>\n    <div class="col-md-3 sg-footer">\n        <strong><a href="#" editable-number="pageSetting.pageSize" e-min="20" e-max="200" onaftersave="changed(1)">\n            {{footer}}, {{ pageSetting.pageSize }} per page</a> </strong>\n    </div>\n</div>')}]),angular.module("template/simplegrid/header.html",[]).run(["$templateCache",function(a){a.put("template/simplegrid/header.html",'<div class="row well well-sm sg-gridheader" >\n    <div class="{{col.$getColumnClass()}}" ng-repeat="col in columns">\n        <input type="checkbox" ng-if="col.checkbox" ng-model="col.checkedAll" ng-change="checkAll(col.checkedAll)"\n               style="margin-top: 8px;margin-left: -10px">\n        <a href ng-click="col.$sort()" class="btn-header">{{col.$getTitle()}}</a>\n        <i class="fa fa-sort-desc" ng-show="col.sortOrder"></i>\n        <i class="fa fa-sort-asc" ng-show="!col.sortOrder && col.sortOrder!=undefined"></i>\n    </div>\n</div>')}]),angular.module("template/simplegrid/simpleGrid-normal.html",[]).run(["$templateCache",function(a){a.put("template/simplegrid/simpleGrid-normal.html",'<div class="sg-grid">\n    <ng-include src="\'template/simplegrid/header.html\'"></ng-include>\n    <div style="{{scrollStyle}}">\n        <div ng-repeat="item in items" class="row sg-gridrow" ng-click="clickRow(item,$event)" ng-class="{true: \'sg-gridrow-active\'}[item.$__selected]" >\n            <div class="{{col.$getColumnClass()}}" ng-repeat="col in columns">\n                <i ng-if="col.bool" ng-class="{true: \'fa fa-check\'}[item[col.name]]"></i>\n                <a href ng-if="$first && sgAllowDel" ng-click="DelObject(item)"><i class= \'glyphicon glyphicon-remove\'></i></a>\n                <ng-include  ng-if="col.template" src="col.template"></ng-include>\n                <span ng-if="!col.template && !col.checkbox">{{col.$getText(item)}}</span>\n                <label ng-if="col.checkbox" ng-click="$event.stopPropagation()">{{col.$getText(item)}}<input type="checkbox" ng-model="item.__selected"></label>\n            </div>\n        </div>\n    </div>\n    <ng-include src="\'template/simplegrid/footer.html\'"></ng-include>\n</div>')}]),angular.module("template/simplegrid/simpleGrid-simple.html",[]).run(["$templateCache",function(a){a.put("template/simplegrid/simpleGrid-simple.html",'<div class="sg-grid">\n    <ng-include src="itemtemplate"></ng-include>\n    <ng-include src="\'template/simplegrid/footer.html\'"></ng-include>\n</div>')}]),angular.module("template/simplegrid/simpleGrid.html",[]).run(["$templateCache",function(a){a.put("template/simplegrid/simpleGrid.html",'<div class="form-horizontal sg-grid">\n    <div class="input-group" style="width: 320px;margin-bottom: 15px" ng-if="sgAddObject && sgSortOptions">\n        <span class="input-group-addon"><i class="fa fa-check-circle"></i></span>\n        <select class="form-control">\n            <option ng-repeat="item in sgSortOptions" ng-selected="item.selected" value="item.name">{{item.text}}</option>\n        </select>\n        <div class="input-group-btn">\n            <button type="button" class="btn btn-default" ng-click="sortGrid(true)"><i class="fa fa-sort-amount-asc"></i></button>\n            <button type="button" class="btn btn-default" ng-click="sortGrid(false)"><i class="fa fa-sort-amount-desc"></i></button>\n            <button type="button" class="btn btn-default" ng-click="sgAddObject()" ng-if="sgAddObject"><span class="glyphicon glyphicon-plus"></span></button>\n        </div>\n    </div>\n    <ng-include src="\'template/simplegrid/header.html\'" ng-if="sgColumns"></ng-include>\n    <div style="{{scrollStyle}}">\n        <div ng-repeat="item in items" style="padding: 3px 0px 3px">\n            <ng-include src="itemtemplate"></ng-include>\n        </div>\n    </div>\n    <ng-include src="\'template/simplegrid/footer.html\'"></ng-include>\n</div>')}]);